<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .gem-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
        }
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
    <div class="w-full min-h-screen px-4 py-6 sm:px-6 md:px-8 lg:px-12 max-w-6xl mx-auto">
        
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-white">Card Tool</h1>
                    <p class="text-zinc-500 text-sm mt-1">Trading Card Odds Visualizer</p>
                </div>
                
                <!-- 3 Dropdowns -->
                <div class="flex flex-col sm:flex-row gap-2">
                    <select id="sportSelect" class="bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-500">
                        <option value="" disabled selected>Sport...</option>
                    </select>
                    <select id="yearSelect" disabled class="bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-500 disabled:opacity-50">
                        <option value="" disabled selected>Year...</option>
                    </select>
                    <select id="productSelect" disabled class="bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-500 disabled:opacity-50">
                        <option value="" disabled selected>Product...</option>
                    </select>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main>
            <!-- Loading State -->
            <div id="loadingState" class="flex flex-col items-center justify-center py-20">
                <div class="text-4xl mb-4 loading-pulse">üé¥</div>
                <p class="text-zinc-500 text-sm">Loading data from Google Sheets...</p>
            </div>

            <!-- Error State -->
            <div id="errorState" class="hidden flex flex-col items-center justify-center py-20">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-xl font-semibold text-zinc-300 mb-2">Unable to Load Data</h2>
                <p class="text-zinc-500 text-sm text-center max-w-md mb-4">Google Sheets can't be accessed from this preview due to browser restrictions.</p>
                <p class="text-zinc-600 text-xs text-center max-w-md">This will work when hosted on GitHub Pages or your own domain.</p>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
                <div class="text-6xl mb-6">üé¥</div>
                <h2 class="text-xl font-semibold text-zinc-300 mb-2">Select a Product</h2>
                <p class="text-zinc-500 text-sm text-center max-w-md">Choose a trading card product to explore pack odds.</p>
            </div>

            <div id="productContent" class="hidden"></div>
        </main>

    </div>

    <script>
        // ============ GOOGLE SHEETS CONFIG ============
        const SHEET_ID = '1m_snihKKWJEGRfwaNdoIiR4-eMrO0YYmm7mnD_8HteQ';
        
        // GID for each tab
        const SHEET_GIDS = {
            products: 0,
            odds: 2126001521,
            checklist: 444343756
        };

        function getSheetURL(tabName) {
            const gid = SHEET_GIDS[tabName];
            if (gid !== null) {
                return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            }
            // Fallback to sheet name method
            return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tabName)}`;
        }

        // ============ CSV PARSER ============
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            
            // Parse header
            const headers = parseCSVLine(lines[0]);
            
            // Parse rows
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(s => s.replace(/^"|"$/g, ''));
        }

        // ============ DATA ============
        let PRODUCTS = {};
        let ODDS_RAW = [];
        let CHECKLIST = [];

        // ============ STATE ============
        let state = { 
            sport: null, 
            year: null, 
            product: null,
            config: 'hobby'
        };

        // ============ DATA PROCESSING ============
        function processProducts(rows) {
            const products = {};
            rows.forEach(row => {
                if (row.product_id) {
                    products[row.product_id] = {
                        name: row.name || '',
                        sport: row.sport || '',
                        brand: row.brand || '',
                        year: row.year || '',
                        configs: {
                            hobby: { name: 'Hobby Box', packs: 20, cardsPerPack: 4 },
                            jumbo: { name: 'Jumbo Box', packs: 12, cardsPerPack: 13 },
                            breaker: { name: 'Breaker Box', packs: 10, cardsPerPack: 20 },
                            value: { name: 'Value Box', packs: 6, cardsPerPack: 6 },
                            hanger: { name: 'Hanger Box', packs: 1, cardsPerPack: 30 },
                            mega: { name: 'Mega Box', packs: 7, cardsPerPack: 5 }
                        }
                    };
                }
            });
            return products;
        }

        function getOddsForProduct(productId, config) {
            const filtered = ODDS_RAW.filter(row => 
                row.product_id === productId && row.config === config
            );

            // Group by category
            const baseParallels = filtered
                .filter(row => row.category === 'base')
                .map(row => ({
                    name: row.parallel || row.card_type,
                    odds: row.odds ? formatOddsValue(row.odds) : null,
                    numbered: row.numbered || null
                }));

            const inserts = filtered
                .filter(row => row.category === 'insert')
                .map(row => ({
                    name: row.card_type,
                    odds: row.odds ? formatOddsValue(row.odds) : null,
                    type: row.parallel === 'SSP' ? 'ssp' : 'insert',
                    checklist: row.checklist ? parseInt(row.checklist) : null
                }));

            const autographs = filtered
                .filter(row => row.category === 'auto')
                .map(row => ({
                    name: row.card_type,
                    odds: row.odds ? formatOddsValue(row.odds) : null,
                    checklist: row.checklist ? parseInt(row.checklist) : null
                }));

            return {
                base_parallels: baseParallels.length > 0 ? baseParallels : null,
                inserts: inserts.length > 0 ? inserts : null,
                autographs: autographs.length > 0 ? autographs : null
            };
        }

        function formatOddsValue(odds) {
            // Handle if odds is just a number
            if (!isNaN(odds)) {
                const num = parseFloat(odds);
                if (num >= 1) return `1:${num}`;
                if (num > 0) return `${Math.round(1/num)}:1`;
            }
            // Already formatted
            if (odds.includes(':')) return odds;
            return `1:${odds}`;
        }

        function getAvailableConfigs(productId) {
            const configs = new Set();
            ODDS_RAW.filter(row => row.product_id === productId)
                .forEach(row => configs.add(row.config));
            return Array.from(configs);
        }

        // ============ HELPERS ============
        function getAvailableSports() {
            const sports = new Set();
            Object.values(PRODUCTS).forEach(p => sports.add(p.sport));
            return Array.from(sports).sort();
        }

        function getYearsBySport(sport) {
            const years = new Set();
            Object.values(PRODUCTS).filter(p => p.sport === sport).forEach(p => years.add(p.year));
            return Array.from(years).sort((a, b) => b.localeCompare(a));
        }

        function getProducts(sport, year) {
            return Object.entries(PRODUCTS)
                .filter(([id, p]) => p.sport === sport && p.year === year)
                .map(([id, p]) => ({ id, ...p }));
        }

        function parseOdds(oddsStr) {
            if (!oddsStr) return null;
            const parts = oddsStr.split(':');
            if (parts.length !== 2) return null;
            const [num, denom] = parts.map(Number);
            if (num > 1) return 1 / num;
            return denom;
        }

        function formatOdds(oddsStr) {
            return oddsStr || '‚Äî';
        }

        function getRarityColor(oddsStr) {
            const odds = parseOdds(oddsStr);
            if (!odds || odds < 1) return 'text-emerald-400';
            if (odds <= 20) return 'text-emerald-400';
            if (odds <= 100) return 'text-blue-400';
            if (odds <= 500) return 'text-violet-400';
            if (odds <= 2000) return 'text-amber-400';
            if (odds <= 10000) return 'text-orange-400';
            return 'text-red-400';
        }

        // ============ HIDDEN GEM DETECTION ============
        function findHiddenGem(productId, config) {
            const odds = getOddsForProduct(productId, config);
            
            // Look for inserts that are surprisingly rare compared to their peers
            if (odds.inserts && odds.inserts.length > 1) {
                const regularInserts = odds.inserts.filter(i => i.type !== 'ssp');
                if (regularInserts.length > 1) {
                    // Sort by odds (higher = rarer)
                    const sorted = regularInserts
                        .filter(i => i.odds)
                        .sort((a, b) => parseOdds(b.odds) - parseOdds(a.odds));
                    
                    if (sorted.length >= 2) {
                        const rarest = sorted[0];
                        const secondRarest = sorted[1];
                        const rarestOdds = parseOdds(rarest.odds);
                        const secondOdds = parseOdds(secondRarest.odds);
                        
                        // If rarest is 3x+ harder than second rarest, it's a hidden gem
                        if (rarestOdds > secondOdds * 3) {
                            return {
                                card: `${rarest.name} Insert`,
                                odds: rarest.odds,
                                reason: `${Math.round(rarestOdds / secondOdds)}x rarer than ${secondRarest.name} (${secondRarest.odds})`,
                                comparison: 'Overlooked insert that\'s harder to pull than most realize'
                            };
                        }
                    }
                }
            }
            
            return null;
        }

        // ============ URL / DEEP LINKING ============
        function updateURL() {
            const params = new URLSearchParams();
            if (state.sport) params.set('sport', state.sport);
            if (state.year) params.set('year', state.year);
            if (state.product) params.set('product', state.product);
            if (state.config) params.set('config', state.config);
            
            const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', newURL);
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const sport = params.get('sport');
            const year = params.get('year');
            const product = params.get('product');
            const config = params.get('config');

            if (config) state.config = config;

            if (sport && getAvailableSports().includes(sport)) {
                document.getElementById('sportSelect').value = sport;
                onSportChange(sport, false);

                if (year && getYearsBySport(sport).includes(year)) {
                    document.getElementById('yearSelect').value = year;
                    onYearChange(year, false);

                    if (product && PRODUCTS[product]) {
                        document.getElementById('productSelect').value = product;
                        onProductChange(product, false);
                    }
                }
            }
        }

        // ============ HANDLERS ============
        function onSportChange(sport, updateUrl = true) {
            state.sport = sport;
            state.year = null;
            state.product = null;

            const yearSelect = document.getElementById('yearSelect');
            const years = getYearsBySport(sport);
            yearSelect.innerHTML = '<option value="" disabled selected>Year...</option>';
            years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);
            yearSelect.disabled = false;

            document.getElementById('productSelect').innerHTML = '<option value="" disabled selected>Product...</option>';
            document.getElementById('productSelect').disabled = true;
            
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('productContent').classList.add('hidden');

            if (updateUrl) updateURL();
        }

        function onYearChange(year, updateUrl = true) {
            state.year = year;
            state.product = null;

            const productSelect = document.getElementById('productSelect');
            const products = getProducts(state.sport, year);
            productSelect.innerHTML = '<option value="" disabled selected>Product...</option>';
            products.forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.brand}</option>`);
            productSelect.disabled = false;

            if (updateUrl) updateURL();
        }

        function onProductChange(productId, updateUrl = true) {
            state.product = productId;
            
            // Set default config to first available
            const availableConfigs = getAvailableConfigs(productId);
            if (availableConfigs.length > 0 && !availableConfigs.includes(state.config)) {
                state.config = availableConfigs[0];
            }
            
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('productContent').classList.remove('hidden');
            renderProductContent();
            if (updateUrl) updateURL();
        }

        function setConfig(config) {
            state.config = config;
            renderProductContent();
            updateURL();
        }

        // ============ RENDER ============
        function renderProductContent() {
            const product = PRODUCTS[state.product];
            if (!product) {
                document.getElementById('productContent').innerHTML = '<p class="text-zinc-500">No data available</p>';
                return;
            }

            const currentOdds = getOddsForProduct(state.product, state.config);
            const hiddenGem = findHiddenGem(state.product, state.config);
            const availableConfigs = getAvailableConfigs(state.product);
            const configInfo = product.configs[state.config] || {};
            const totalCards = (configInfo.packs || 0) * (configInfo.cardsPerPack || 0);

            document.getElementById('productContent').innerHTML = `
                <!-- Product Header -->
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-white">${product.name}</h2>
                    <p class="text-zinc-500 text-sm mt-1">${product.sport} ‚Ä¢ ${product.brand} ‚Ä¢ ${product.year}</p>
                </div>

                <!-- Config Tabs -->
                <div class="flex flex-wrap gap-2 mb-6">
                    ${availableConfigs.map(key => `
                        <button onclick="setConfig('${key}')" 
                            class="px-4 py-2 rounded-lg text-sm font-medium transition-all capitalize
                            ${state.config === key 
                                ? 'bg-white text-zinc-900' 
                                : 'bg-zinc-800 text-zinc-400 hover:bg-zinc-700 hover:text-zinc-200'}">
                            ${key}
                        </button>
                    `).join('')}
                </div>

                <!-- Box Info -->
                <div class="bg-zinc-900 rounded-lg p-4 mb-6 flex flex-wrap gap-6">
                    <div>
                        <div class="text-zinc-500 text-xs uppercase tracking-wide">Packs</div>
                        <div class="text-xl font-bold text-white">${configInfo.packs || '‚Äî'}</div>
                    </div>
                    <div>
                        <div class="text-zinc-500 text-xs uppercase tracking-wide">Cards/Pack</div>
                        <div class="text-xl font-bold text-white">${configInfo.cardsPerPack || '‚Äî'}</div>
                    </div>
                    <div>
                        <div class="text-zinc-500 text-xs uppercase tracking-wide">Total Cards</div>
                        <div class="text-xl font-bold text-white">${totalCards || '‚Äî'}</div>
                    </div>
                </div>

                <!-- Hidden Gem -->
                ${hiddenGem ? `
                <div class="gem-gradient rounded-lg p-4 mb-6">
                    <div class="flex items-start gap-3">
                        <div class="text-2xl">üí§</div>
                        <div>
                            <div class="text-xs uppercase tracking-wide text-amber-900 font-semibold mb-1">Sleeper Hit</div>
                            <div class="text-lg font-bold text-zinc-900">${hiddenGem.card}</div>
                            <div class="text-amber-900 font-semibold">${hiddenGem.odds}</div>
                            <p class="text-amber-900/80 text-sm mt-2">${hiddenGem.reason}</p>
                            <p class="text-amber-900/60 text-xs mt-1">${hiddenGem.comparison}</p>
                        </div>
                    </div>
                </div>
                ` : ''}

                <!-- Base Parallels -->
                ${currentOdds.base_parallels ? `
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-zinc-400 uppercase tracking-wide mb-3">Base Parallels</h3>
                    <div class="grid gap-2">
                        ${currentOdds.base_parallels.map(p => `
                            <div class="bg-zinc-900 rounded-lg px-4 py-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-zinc-200">${p.name}</span>
                                    ${p.numbered ? `<span class="text-xs text-zinc-500">${p.numbered}</span>` : ''}
                                </div>
                                <span class="font-mono font-semibold ${getRarityColor(p.odds)}">${formatOdds(p.odds)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Inserts -->
                ${currentOdds.inserts ? `
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-zinc-400 uppercase tracking-wide mb-3">Inserts</h3>
                    <div class="grid gap-2">
                        ${currentOdds.inserts.map(p => `
                            <div class="bg-zinc-900 rounded-lg px-4 py-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-zinc-200">${p.name}</span>
                                    ${p.type === 'ssp' ? `<span class="text-xs bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded">SSP</span>` : ''}
                                    ${p.checklist ? `<span class="text-xs text-zinc-500">${p.checklist} cards</span>` : ''}
                                </div>
                                <span class="font-mono font-semibold ${getRarityColor(p.odds)}">${formatOdds(p.odds)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Autographs -->
                ${currentOdds.autographs ? `
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-zinc-400 uppercase tracking-wide mb-3">Autographs</h3>
                    <div class="grid gap-2">
                        ${currentOdds.autographs.map(p => `
                            <div class="bg-zinc-900 rounded-lg px-4 py-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-zinc-200">${p.name}</span>
                                    ${p.checklist ? `<span class="text-xs text-zinc-500">${p.checklist} signers</span>` : ''}
                                </div>
                                <span class="font-mono font-semibold ${getRarityColor(p.odds)}">${formatOdds(p.odds)}</span>
                            </div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- No Data Message -->
                ${!currentOdds.base_parallels && !currentOdds.inserts && !currentOdds.autographs ? `
                <div class="text-center py-12">
                    <p class="text-zinc-500">No odds data for ${state.config} configuration yet.</p>
                    <p class="text-zinc-600 text-sm mt-2">Add data to the Google Sheet to see it here.</p>
                </div>
                ` : ''}

                <!-- Footer -->
                <div class="text-center text-zinc-600 text-xs mt-12 pb-8">
                    Data from Google Sheets. Last loaded: ${new Date().toLocaleTimeString()}
                </div>
            `;
        }

        // ============ DATA LOADING ============
        async function fetchSheet(tabName) {
            const url = getSheetURL(tabName);
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to fetch ${tabName}`);
            const csvText = await response.text();
            return parseCSV(csvText);
        }

        async function loadData() {
            try {
                // Fetch all sheets in parallel
                const [productsData, oddsData, checklistData] = await Promise.all([
                    fetchSheet('products'),
                    fetchSheet('odds'),
                    fetchSheet('checklist')
                ]);

                console.log('Raw products data:', productsData);

                PRODUCTS = processProducts(productsData);
                ODDS_RAW = oddsData;
                CHECKLIST = checklistData;

                console.log('‚úì Data loaded from Google Sheets');
                console.log('  Products:', PRODUCTS);
                console.log('  Sports:', getAvailableSports());
                console.log('  Odds rows:', ODDS_RAW.length);

                return true;
            } catch (error) {
                console.error('‚úó Failed to load from Google Sheets:', error.message);
                console.error('Full error:', error);
                return false;
            }
        }

        // ============ INIT ============
        async function init() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const emptyState = document.getElementById('emptyState');

            const success = await loadData();

            loadingState.classList.add('hidden');

            if (!success) {
                errorState.classList.remove('hidden');
                return;
            }

            emptyState.classList.remove('hidden');

            const sportSelect = document.getElementById('sportSelect');
            getAvailableSports().forEach(sport => {
                sportSelect.innerHTML += `<option value="${sport}">${sport}</option>`;
            });

            sportSelect.addEventListener('change', e => onSportChange(e.target.value));
            document.getElementById('yearSelect').addEventListener('change', e => onYearChange(e.target.value));
            document.getElementById('productSelect').addEventListener('change', e => onProductChange(e.target.value));

            loadFromURL();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
