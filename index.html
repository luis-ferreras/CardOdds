<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Card Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .sleeper-gradient {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 50%, #d97706 100%);
        }
        .loading-pulse {
            animation: pulse 1.5s ease-in-out infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 1; }
        }
        .ladder-bar {
            transition: width 0.3s ease;
        }
    </style>
</head>
<body class="bg-zinc-950 text-zinc-100 min-h-screen">
    <div class="w-full min-h-screen px-4 py-6 sm:px-6 md:px-8 lg:px-12 max-w-6xl mx-auto">
        
        <header class="mb-8">
            <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                    <h1 class="text-2xl font-bold text-white">Card Tool</h1>
                    <p class="text-zinc-500 text-sm mt-1">Trading Card Odds Visualizer</p>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-2">
                    <select id="sportSelect" class="bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-500">
                        <option value="" disabled selected>Sport...</option>
                    </select>
                    <select id="yearSelect" disabled class="bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-500 disabled:opacity-50">
                        <option value="" disabled selected>Year...</option>
                    </select>
                    <select id="productSelect" disabled class="bg-zinc-900 border border-zinc-700 rounded-lg px-4 py-3 text-sm focus:outline-none focus:border-zinc-500 disabled:opacity-50">
                        <option value="" disabled selected>Product...</option>
                    </select>
                </div>
            </div>
        </header>

        <main>
            <div id="loadingState" class="flex flex-col items-center justify-center py-20">
                <div class="text-4xl mb-4 loading-pulse">üé¥</div>
                <p class="text-zinc-500 text-sm">Loading data from Google Sheets...</p>
            </div>

            <div id="errorState" class="hidden flex flex-col items-center justify-center py-20">
                <div class="text-4xl mb-4">‚ö†Ô∏è</div>
                <h2 class="text-xl font-semibold text-zinc-300 mb-2">Unable to Load Data</h2>
                <p class="text-zinc-500 text-sm text-center max-w-md mb-4">Google Sheets can't be accessed from this preview due to browser restrictions.</p>
                <p class="text-zinc-600 text-xs text-center max-w-md">This will work when hosted on GitHub Pages or your own domain.</p>
            </div>

            <div id="emptyState" class="hidden flex flex-col items-center justify-center py-20">
                <div class="text-6xl mb-6">üé¥</div>
                <h2 class="text-xl font-semibold text-zinc-300 mb-2">Select a Product</h2>
                <p class="text-zinc-500 text-sm text-center max-w-md">Choose a trading card product to explore pack odds.</p>
            </div>

            <div id="productContent" class="hidden"></div>
        </main>
    </div>

    <script>
        const SHEET_ID = '1m_snihKKWJEGRfwaNdoIiR4-eMrO0YYmm7mnD_8HteQ';
        const SHEET_GIDS = { products: 0, odds: 2126001521, checklist: 444343756 };

        function getSheetURL(tabName) {
            const gid = SHEET_GIDS[tabName];
            if (gid !== null) {
                return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;
            }
            return `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(tabName)}`;
        }

        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            if (lines.length === 0) return [];
            const headers = parseCSVLine(lines[0]);
            const data = [];
            for (let i = 1; i < lines.length; i++) {
                if (lines[i].trim() === '') continue;
                const values = parseCSVLine(lines[i]);
                const row = {};
                headers.forEach((header, index) => {
                    row[header.trim()] = values[index] ? values[index].trim() : '';
                });
                data.push(row);
            }
            return data;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result.map(s => s.replace(/^"|"$/g, ''));
        }

        let PRODUCTS = {};
        let ODDS_RAW = [];
        let CHECKLIST = [];

        let state = { 
            sport: null, 
            year: null, 
            product: null,
            config: 'hobby',
            view: 'compare'
        };

        function processProducts(rows) {
            const products = {};
            rows.forEach(row => {
                if (row.product_id) {
                    products[row.product_id] = {
                        name: row.name || '',
                        sport: row.sport || '',
                        brand: row.brand || '',
                        year: row.year || '',
                        configs: {
                            hobby: { name: 'Hobby Box', packs: 20, cardsPerPack: 4 },
                            jumbo: { name: 'Jumbo Box', packs: 12, cardsPerPack: 13 },
                            breaker: { name: 'Breaker Box', packs: 10, cardsPerPack: 20 },
                            value: { name: 'Value Box', packs: 6, cardsPerPack: 6 },
                            hanger: { name: 'Hanger Box', packs: 1, cardsPerPack: 30 },
                            mega: { name: 'Mega Box', packs: 7, cardsPerPack: 5 }
                        }
                    };
                }
            });
            return products;
        }

        function getOddsForProduct(productId, config) {
            const filtered = ODDS_RAW.filter(row => row.product_id === productId && row.config === config);
            const baseParallels = filtered.filter(row => row.category === 'base').map(row => ({
                name: row.parallel || row.card_type,
                odds: row.odds ? formatOddsValue(row.odds) : null,
                numbered: row.numbered || null
            }));
            const inserts = filtered.filter(row => row.category === 'insert').map(row => ({
                name: row.card_type,
                odds: row.odds ? formatOddsValue(row.odds) : null,
                type: row.parallel === 'SSP' ? 'ssp' : 'insert',
                checklist: row.checklist ? parseInt(row.checklist) : null
            }));
            const autographs = filtered.filter(row => row.category === 'auto').map(row => ({
                name: row.card_type,
                odds: row.odds ? formatOddsValue(row.odds) : null,
                checklist: row.checklist ? parseInt(row.checklist) : null
            }));
            return {
                base_parallels: baseParallels.length > 0 ? baseParallels : null,
                inserts: inserts.length > 0 ? inserts : null,
                autographs: autographs.length > 0 ? autographs : null
            };
        }

        function getAllParallelsForProduct(productId) {
            const parallels = new Map();
            ODDS_RAW.filter(row => row.product_id === productId && row.category === 'base').forEach(row => {
                const name = row.parallel || row.card_type;
                if (!parallels.has(name)) parallels.set(name, {});
                parallels.get(name)[row.config] = row.odds ? formatOddsValue(row.odds) : null;
            });
            return parallels;
        }

        function getAllInsertsForProduct(productId) {
            const inserts = new Map();
            ODDS_RAW.filter(row => row.product_id === productId && row.category === 'insert').forEach(row => {
                const name = row.card_type;
                if (!inserts.has(name)) inserts.set(name, { isSSP: row.parallel === 'SSP' });
                inserts.get(name)[row.config] = row.odds ? formatOddsValue(row.odds) : null;
            });
            return inserts;
        }

        function getAllAutographsForProduct(productId) {
            const autos = new Map();
            ODDS_RAW.filter(row => row.product_id === productId && row.category === 'auto').forEach(row => {
                const name = row.card_type;
                if (!autos.has(name)) autos.set(name, {});
                autos.get(name)[row.config] = row.odds ? formatOddsValue(row.odds) : null;
            });
            return autos;
        }

        function formatOddsValue(odds) {
            if (!isNaN(odds)) {
                const num = parseFloat(odds);
                if (num >= 1) return `1:${num}`;
                if (num > 0) return `${Math.round(1/num)}:1`;
            }
            if (odds.includes(':')) return odds;
            return `1:${odds}`;
        }

        function getAvailableConfigs(productId) {
            const configs = new Set();
            ODDS_RAW.filter(row => row.product_id === productId).forEach(row => configs.add(row.config));
            return Array.from(configs);
        }

        function getAvailableSports() {
            const sports = new Set();
            Object.values(PRODUCTS).forEach(p => sports.add(p.sport));
            return Array.from(sports).sort();
        }

        function getYearsBySport(sport) {
            const years = new Set();
            Object.values(PRODUCTS).filter(p => p.sport === sport).forEach(p => years.add(p.year));
            return Array.from(years).sort((a, b) => b.localeCompare(a));
        }

        function getProducts(sport, year) {
            return Object.entries(PRODUCTS)
                .filter(([id, p]) => p.sport === sport && p.year === year)
                .map(([id, p]) => ({ id, ...p }));
        }

        function parseOdds(oddsStr) {
            if (!oddsStr) return null;
            const parts = oddsStr.split(':');
            if (parts.length !== 2) return null;
            const [num, denom] = parts.map(Number);
            if (num > 1) return 1 / num;
            return denom;
        }

        function formatOdds(oddsStr) { return oddsStr || '‚Äî'; }

        function getRarityColor(oddsStr) {
            const odds = parseOdds(oddsStr);
            if (!odds || odds < 1) return 'text-emerald-400';
            if (odds <= 20) return 'text-emerald-400';
            if (odds <= 100) return 'text-blue-400';
            if (odds <= 500) return 'text-violet-400';
            if (odds <= 2000) return 'text-amber-400';
            if (odds <= 10000) return 'text-orange-400';
            return 'text-red-400';
        }

        function getRarityBg(oddsStr) {
            const odds = parseOdds(oddsStr);
            if (!odds || odds < 1) return 'bg-emerald-500';
            if (odds <= 20) return 'bg-emerald-500';
            if (odds <= 100) return 'bg-blue-500';
            if (odds <= 500) return 'bg-violet-500';
            if (odds <= 2000) return 'bg-amber-500';
            if (odds <= 10000) return 'bg-orange-500';
            return 'bg-red-500';
        }

        function getRarityTier(oddsStr) {
            const odds = parseOdds(oddsStr);
            if (!odds || odds <= 10) return { name: 'Common', emoji: 'üü¢', color: 'emerald' };
            if (odds <= 50) return { name: 'Uncommon', emoji: 'üîµ', color: 'blue' };
            if (odds <= 200) return { name: 'Rare', emoji: 'üü£', color: 'violet' };
            return { name: 'Chase', emoji: 'üü†', color: 'orange' };
        }

        function findSleeperHit(productId, config) {
            const odds = getOddsForProduct(productId, config);
            if (odds.base_parallels && odds.base_parallels.length > 1) {
                const sorted = odds.base_parallels.filter(p => p.odds).sort((a, b) => parseOdds(b.odds) - parseOdds(a.odds));
                if (sorted.length >= 2) {
                    const rarest = sorted[0];
                    const secondRarest = sorted[1];
                    const rarestOdds = parseOdds(rarest.odds);
                    const secondOdds = parseOdds(secondRarest.odds);
                    if (rarestOdds > secondOdds * 3) {
                        return {
                            card: rarest.name,
                            odds: rarest.odds,
                            reason: `${Math.round(rarestOdds / secondOdds)}x rarer than ${secondRarest.name}`,
                            comparison: 'Overlooked parallel that\'s harder to pull than most realize'
                        };
                    }
                }
            }
            return null;
        }

        function findBestValueConfig(productId, parallelName) {
            const configs = getAvailableConfigs(productId);
            let bestConfig = null;
            let bestOdds = Infinity;
            configs.forEach(config => {
                const row = ODDS_RAW.find(r => r.product_id === productId && r.config === config && (r.parallel === parallelName || r.card_type === parallelName));
                if (row && row.odds) {
                    const odds = parseFloat(row.odds);
                    if (odds < bestOdds) { bestOdds = odds; bestConfig = config; }
                }
            });
            return bestConfig ? { config: bestConfig, odds: `1:${bestOdds}` } : null;
        }

        function findChaseCards(productId, config) {
            const filtered = ODDS_RAW.filter(row => row.product_id === productId && row.config === config && row.odds);
            return filtered.map(row => ({
                name: row.parallel || row.card_type,
                category: row.category,
                odds: formatOddsValue(row.odds),
                oddsNum: parseFloat(row.odds)
            })).filter(c => c.oddsNum >= 200).sort((a, b) => b.oddsNum - a.oddsNum).slice(0, 5);
        }

        function calculateExpectedHits(productId, config) {
            const product = PRODUCTS[productId];
            if (!product) return [];
            const configInfo = product.configs[config];
            if (!configInfo) return [];
            const totalCards = configInfo.packs * configInfo.cardsPerPack;
            const filtered = ODDS_RAW.filter(row => row.product_id === productId && row.config === config && row.category === 'base' && row.odds);
            return filtered.map(row => {
                const odds = parseFloat(row.odds);
                const expected = totalCards / odds;
                return {
                    name: row.parallel || row.card_type,
                    odds: formatOddsValue(row.odds),
                    expected: expected,
                    display: expected >= 1 ? expected.toFixed(1) : `${(expected * 100).toFixed(0)}%`
                };
            }).sort((a, b) => b.expected - a.expected);
        }

        function groupByRarityTier(productId, config) {
            const filtered = ODDS_RAW.filter(row => row.product_id === productId && row.config === config && row.odds);
            const tiers = { common: [], uncommon: [], rare: [], chase: [] };
            filtered.forEach(row => {
                const odds = parseFloat(row.odds);
                const item = { name: row.parallel || row.card_type, category: row.category, odds: formatOddsValue(row.odds) };
                if (odds <= 10) tiers.common.push(item);
                else if (odds <= 50) tiers.uncommon.push(item);
                else if (odds <= 200) tiers.rare.push(item);
                else tiers.chase.push(item);
            });
            return tiers;
        }

        function updateURL() {
            const params = new URLSearchParams();
            if (state.sport) params.set('sport', state.sport);
            if (state.year) params.set('year', state.year);
            if (state.product) params.set('product', state.product);
            if (state.config) params.set('config', state.config);
            if (state.view !== 'compare') params.set('view', state.view);
            const newURL = params.toString() ? `?${params.toString()}` : window.location.pathname;
            window.history.replaceState({}, '', newURL);
        }

        function loadFromURL() {
            const params = new URLSearchParams(window.location.search);
            const sport = params.get('sport');
            const year = params.get('year');
            const product = params.get('product');
            const config = params.get('config');
            const view = params.get('view');
            if (config) state.config = config;
            if (view && ['compare', 'ladder', 'calculator', 'insights'].includes(view)) state.view = view;
            if (sport && getAvailableSports().includes(sport)) {
                document.getElementById('sportSelect').value = sport;
                onSportChange(sport, false);
                if (year && getYearsBySport(sport).includes(year)) {
                    document.getElementById('yearSelect').value = year;
                    onYearChange(year, false);
                    if (product && PRODUCTS[product]) {
                        document.getElementById('productSelect').value = product;
                        onProductChange(product, false);
                    }
                }
            }
        }

        function onSportChange(sport, updateUrl = true) {
            state.sport = sport;
            state.year = null;
            state.product = null;
            const yearSelect = document.getElementById('yearSelect');
            const years = getYearsBySport(sport);
            yearSelect.innerHTML = '<option value="" disabled selected>Year...</option>';
            years.forEach(y => yearSelect.innerHTML += `<option value="${y}">${y}</option>`);
            yearSelect.disabled = false;
            document.getElementById('productSelect').innerHTML = '<option value="" disabled selected>Product...</option>';
            document.getElementById('productSelect').disabled = true;
            document.getElementById('emptyState').classList.remove('hidden');
            document.getElementById('productContent').classList.add('hidden');
            if (updateUrl) updateURL();
        }

        function onYearChange(year, updateUrl = true) {
            state.year = year;
            state.product = null;
            const productSelect = document.getElementById('productSelect');
            const products = getProducts(state.sport, year);
            productSelect.innerHTML = '<option value="" disabled selected>Product...</option>';
            products.forEach(p => productSelect.innerHTML += `<option value="${p.id}">${p.brand}</option>`);
            productSelect.disabled = false;
            if (updateUrl) updateURL();
        }

        function onProductChange(productId, updateUrl = true) {
            state.product = productId;
            const availableConfigs = getAvailableConfigs(productId);
            if (availableConfigs.length > 0 && !availableConfigs.includes(state.config)) {
                state.config = availableConfigs[0];
            }
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('productContent').classList.remove('hidden');
            renderProductContent();
            if (updateUrl) updateURL();
        }

        function setConfig(config) {
            state.config = config;
            renderProductContent();
            updateURL();
        }

        function setView(view) {
            state.view = view;
            renderProductContent();
            updateURL();
        }

        function renderViewTabs() {
            return `
                <div class="flex flex-wrap gap-2 mb-6 border-b border-zinc-800 pb-4">
                    <button onclick="setView('compare')" class="px-3 py-1.5 rounded text-sm font-medium transition-all ${state.view === 'compare' ? 'bg-zinc-700 text-white' : 'text-zinc-500 hover:text-zinc-300'}">‚öñÔ∏è Compare</button>
                    <button onclick="setView('ladder')" class="px-3 py-1.5 rounded text-sm font-medium transition-all ${state.view === 'ladder' ? 'bg-zinc-700 text-white' : 'text-zinc-500 hover:text-zinc-300'}">ü™ú Ladder</button>
                    <button onclick="setView('calculator')" class="px-3 py-1.5 rounded text-sm font-medium transition-all ${state.view === 'calculator' ? 'bg-zinc-700 text-white' : 'text-zinc-500 hover:text-zinc-300'}">üßÆ Calculator</button>
                    <button onclick="setView('insights')" class="px-3 py-1.5 rounded text-sm font-medium transition-all ${state.view === 'insights' ? 'bg-zinc-700 text-white' : 'text-zinc-500 hover:text-zinc-300'}">üí° Insights</button>
                </div>
            `;
        }

        function renderComparisonTable(title, dataMap, configs, showSSP = false) {
            if (dataMap.size === 0) return '';
            return `
                <div class="mb-8">
                    <h3 class="text-sm font-semibold text-zinc-400 uppercase tracking-wide mb-3">${title}</h3>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm">
                            <thead>
                                <tr class="border-b border-zinc-800">
                                    <th class="text-left py-3 px-2 text-zinc-400 font-medium">Name</th>
                                    ${configs.map(c => `<th class="text-center py-3 px-2 text-zinc-400 font-medium capitalize">${c}</th>`).join('')}
                                </tr>
                            </thead>
                            <tbody>
                                ${Array.from(dataMap.entries()).map(([name, configOdds]) => {
                                    let bestConfig = null;
                                    let bestOddsNum = Infinity;
                                    configs.forEach(c => {
                                        if (configOdds[c]) {
                                            const num = parseOdds(configOdds[c]);
                                            if (num < bestOddsNum) { bestOddsNum = num; bestConfig = c; }
                                        }
                                    });
                                    const isSSP = showSSP && configOdds.isSSP;
                                    return `
                                        <tr class="border-b border-zinc-800/50">
                                            <td class="py-3 px-2 text-zinc-200">${name}${isSSP ? '<span class="ml-2 text-xs bg-orange-500/20 text-orange-400 px-2 py-0.5 rounded">SSP</span>' : ''}</td>
                                            ${configs.map(c => {
                                                const odds = configOdds[c];
                                                const isBest = c === bestConfig && configs.length > 1;
                                                return `<td class="text-center py-3 px-2"><span class="font-mono ${isBest ? 'text-emerald-400 font-bold' : getRarityColor(odds)}">${odds || '‚Äî'}</span>${isBest ? '<span class="ml-1 text-xs">‚úì</span>' : ''}</td>`;
                                            }).join('')}
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        }

        function renderCompareView() {
            const parallels = getAllParallelsForProduct(state.product);
            const inserts = getAllInsertsForProduct(state.product);
            const autographs = getAllAutographsForProduct(state.product);
            const configs = getAvailableConfigs(state.product);
            return `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-white mb-2">‚öñÔ∏è Config Comparison</h3>
                    <p class="text-zinc-500 text-sm">Compare odds across all box types</p>
                </div>
                ${renderComparisonTable('Base Parallels', parallels, configs)}
                ${renderComparisonTable('Inserts', inserts, configs, true)}
                ${renderComparisonTable('Autographs', autographs, configs)}
                <div class="mt-4 text-xs text-zinc-600">‚úì = Best odds for this card</div>
            `;
        }

        function renderLadderView() {
            const currentOdds = getOddsForProduct(state.product, state.config);
            if (!currentOdds.base_parallels) return '<p class="text-zinc-500">No parallel data available</p>';
            const sorted = [...currentOdds.base_parallels].filter(p => p.odds).sort((a, b) => parseOdds(a.odds) - parseOdds(b.odds));
            const maxOdds = Math.max(...sorted.map(p => parseOdds(p.odds)));
            return `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-white mb-2">ü™ú Rarity Ladder</h3>
                    <p class="text-zinc-500 text-sm">Visual progression from common to chase</p>
                    <div class="flex flex-wrap gap-2 mt-4">
                        ${getAvailableConfigs(state.product).map(key => `
                            <button onclick="setConfig('${key}')" class="px-3 py-1.5 rounded text-xs font-medium transition-all capitalize ${state.config === key ? 'bg-zinc-700 text-white' : 'bg-zinc-800/50 text-zinc-500 hover:text-zinc-300'}">${key}</button>
                        `).join('')}
                    </div>
                </div>
                <div class="space-y-3">
                    ${sorted.map(p => {
                        const odds = parseOdds(p.odds);
                        const width = Math.min(100, (Math.log(odds + 1) / Math.log(maxOdds + 1)) * 100);
                        const tier = getRarityTier(p.odds);
                        return `
                            <div class="bg-zinc-900 rounded-lg p-3">
                                <div class="flex justify-between items-center mb-2">
                                    <div class="flex items-center gap-2">
                                        <span class="text-sm">${tier.emoji}</span>
                                        <span class="text-zinc-200 font-medium">${p.name}</span>
                                    </div>
                                    <span class="font-mono text-sm ${getRarityColor(p.odds)}">${p.odds}</span>
                                </div>
                                <div class="h-2 bg-zinc-800 rounded-full overflow-hidden">
                                    <div class="h-full ${getRarityBg(p.odds)} ladder-bar rounded-full" style="width: ${Math.max(5, width)}%"></div>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-6 flex flex-wrap gap-4 text-xs text-zinc-500">
                    <span>üü¢ Common (1:1-1:10)</span>
                    <span>üîµ Uncommon (1:11-1:50)</span>
                    <span>üü£ Rare (1:51-1:200)</span>
                    <span>üü† Chase (1:200+)</span>
                </div>
            `;
        }

        function renderCalculatorView() {
            const product = PRODUCTS[state.product];
            const expected = calculateExpectedHits(state.product, state.config);
            const configInfo = product.configs[state.config] || {};
            const totalCards = (configInfo.packs || 0) * (configInfo.cardsPerPack || 0);
            return `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-white mb-2">üßÆ Expected Hits Calculator</h3>
                    <p class="text-zinc-500 text-sm">What you can expect to pull per box</p>
                    <div class="flex flex-wrap gap-2 mt-4">
                        ${getAvailableConfigs(state.product).map(key => `
                            <button onclick="setConfig('${key}')" class="px-3 py-1.5 rounded text-xs font-medium transition-all capitalize ${state.config === key ? 'bg-zinc-700 text-white' : 'bg-zinc-800/50 text-zinc-500 hover:text-zinc-300'}">${key}</button>
                        `).join('')}
                    </div>
                </div>
                <div class="bg-zinc-900 rounded-lg p-4 mb-6">
                    <div class="text-zinc-500 text-xs uppercase tracking-wide mb-1">Box Configuration</div>
                    <div class="text-white">
                        <span class="text-2xl font-bold">${totalCards}</span>
                        <span class="text-zinc-400 ml-2">total cards (${configInfo.packs} packs √ó ${configInfo.cardsPerPack} cards)</span>
                    </div>
                </div>
                <div class="grid gap-2">
                    ${expected.map(e => {
                        const isGuaranteed = e.expected >= 1;
                        return `
                            <div class="bg-zinc-900 rounded-lg px-4 py-3 flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <span class="text-zinc-200">${e.name}</span>
                                    <span class="text-xs text-zinc-500">${e.odds}</span>
                                </div>
                                <div class="text-right">
                                    <span class="font-mono font-bold ${isGuaranteed ? 'text-emerald-400' : 'text-amber-400'}">${isGuaranteed ? '~' + e.display : e.display + ' chance'}</span>
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
                <div class="mt-4 text-xs text-zinc-600">Note: These are statistical averages. Actual results will vary.</div>
            `;
        }

        function renderInsightsView() {
            const chaseCards = findChaseCards(state.product, state.config);
            const tiers = groupByRarityTier(state.product, state.config);
            const sleeperHit = findSleeperHit(state.product, state.config);
            const parallels = getAllParallelsForProduct(state.product);
            const bestValues = [];
            parallels.forEach((configOdds, name) => {
                const best = findBestValueConfig(state.product, name);
                if (best) bestValues.push({ name, ...best });
            });
            return `
                <div class="mb-6">
                    <h3 class="text-lg font-semibold text-white mb-2">üí° Insights Dashboard</h3>
                    <p class="text-zinc-500 text-sm">Key insights and analysis for this product</p>
                    <div class="flex flex-wrap gap-2 mt-4">
                        ${getAvailableConfigs(state.product).map(key => `
                            <button onclick="setConfig('${key}')" class="px-3 py-1.5 rounded text-xs font-medium transition-all capitalize ${state.config === key ? 'bg-zinc-700 text-white' : 'bg-zinc-800/50 text-zinc-500 hover:text-zinc-300'}">${key}</button>
                        `).join('')}
                    </div>
                </div>
                <div class="grid gap-6 md:grid-cols-2">
                    ${sleeperHit ? `
                    <div class="sleeper-gradient rounded-lg p-4">
                        <div class="flex items-start gap-3">
                            <div class="text-2xl">üí§</div>
                            <div>
                                <div class="text-xs uppercase tracking-wide text-amber-900 font-semibold mb-1">Sleeper Hit</div>
                                <div class="text-lg font-bold text-zinc-900">${sleeperHit.card}</div>
                                <div class="text-amber-900 font-semibold">${sleeperHit.odds}</div>
                                <p class="text-amber-900/80 text-sm mt-1">${sleeperHit.reason}</p>
                            </div>
                        </div>
                    </div>
                    ` : ''}
                    <div class="bg-zinc-900 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xl">üéØ</span>
                            <h4 class="font-semibold text-white">Chase Cards</h4>
                        </div>
                        ${chaseCards.length > 0 ? `
                            <div class="space-y-2">
                                ${chaseCards.map(c => `
                                    <div class="flex justify-between items-center">
                                        <span class="text-zinc-300 text-sm">${c.name}</span>
                                        <span class="font-mono text-xs ${getRarityColor(c.odds)}">${c.odds}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<p class="text-zinc-500 text-sm">No chase cards (1:200+) in this config</p>'}
                    </div>
                    <div class="bg-zinc-900 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xl">üí∞</span>
                            <h4 class="font-semibold text-white">Best Value Config</h4>
                        </div>
                        <div class="space-y-2">
                            ${bestValues.slice(0, 5).map(v => `
                                <div class="flex justify-between items-center">
                                    <span class="text-zinc-300 text-sm">${v.name}</span>
                                    <span class="text-xs">
                                        <span class="text-emerald-400 font-medium capitalize">${v.config}</span>
                                        <span class="text-zinc-500 ml-1">${v.odds}</span>
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-zinc-900 rounded-lg p-4">
                        <div class="flex items-center gap-2 mb-3">
                            <span class="text-xl">üìä</span>
                            <h4 class="font-semibold text-white">Rarity Breakdown</h4>
                        </div>
                        <div class="grid grid-cols-2 gap-3">
                            <div class="text-center p-2 bg-emerald-500/10 rounded">
                                <div class="text-2xl font-bold text-emerald-400">${tiers.common.length}</div>
                                <div class="text-xs text-zinc-500">Common</div>
                            </div>
                            <div class="text-center p-2 bg-blue-500/10 rounded">
                                <div class="text-2xl font-bold text-blue-400">${tiers.uncommon.length}</div>
                                <div class="text-xs text-zinc-500">Uncommon</div>
                            </div>
                            <div class="text-center p-2 bg-violet-500/10 rounded">
                                <div class="text-2xl font-bold text-violet-400">${tiers.rare.length}</div>
                                <div class="text-xs text-zinc-500">Rare</div>
                            </div>
                            <div class="text-center p-2 bg-orange-500/10 rounded">
                                <div class="text-2xl font-bold text-orange-400">${tiers.chase.length}</div>
                                <div class="text-xs text-zinc-500">Chase</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderProductContent() {
            const product = PRODUCTS[state.product];
            if (!product) {
                document.getElementById('productContent').innerHTML = '<p class="text-zinc-500">No data available</p>';
                return;
            }
            let viewContent = '';
            switch (state.view) {
                case 'ladder': viewContent = renderLadderView(); break;
                case 'calculator': viewContent = renderCalculatorView(); break;
                case 'insights': viewContent = renderInsightsView(); break;
                default: viewContent = renderCompareView();
            }
            document.getElementById('productContent').innerHTML = `
                <div class="mb-6">
                    <h2 class="text-xl font-semibold text-white">${product.name}</h2>
                    <p class="text-zinc-500 text-sm mt-1">${product.sport} ‚Ä¢ ${product.brand} ‚Ä¢ ${product.year}</p>
                </div>
                ${renderViewTabs()}
                ${viewContent}
                <div class="text-center text-zinc-600 text-xs mt-12 pb-8">Data from Google Sheets ‚Ä¢ Last loaded: ${new Date().toLocaleTimeString()}</div>
            `;
        }

        async function fetchSheet(tabName) {
            const url = getSheetURL(tabName);
            const response = await fetch(url);
            if (!response.ok) throw new Error(`Failed to fetch ${tabName}`);
            const csvText = await response.text();
            return parseCSV(csvText);
        }

        async function loadData() {
            try {
                const [productsData, oddsData, checklistData] = await Promise.all([
                    fetchSheet('products'),
                    fetchSheet('odds'),
                    fetchSheet('checklist')
                ]);
                PRODUCTS = processProducts(productsData);
                ODDS_RAW = oddsData;
                CHECKLIST = checklistData;
                console.log('‚úì Data loaded from Google Sheets');
                return true;
            } catch (error) {
                console.error('‚úó Failed to load from Google Sheets:', error.message);
                return false;
            }
        }

        async function init() {
            const loadingState = document.getElementById('loadingState');
            const errorState = document.getElementById('errorState');
            const emptyState = document.getElementById('emptyState');
            const success = await loadData();
            loadingState.classList.add('hidden');
            if (!success) {
                errorState.classList.remove('hidden');
                return;
            }
            emptyState.classList.remove('hidden');
            const sportSelect = document.getElementById('sportSelect');
            getAvailableSports().forEach(sport => {
                sportSelect.innerHTML += `<option value="${sport}">${sport}</option>`;
            });
            sportSelect.addEventListener('change', e => onSportChange(e.target.value));
            document.getElementById('yearSelect').addEventListener('change', e => onYearChange(e.target.value));
            document.getElementById('productSelect').addEventListener('change', e => onProductChange(e.target.value));
            loadFromURL();
        }

        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
